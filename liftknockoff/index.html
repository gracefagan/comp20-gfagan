<!DOCTYPE html>
<html>
<head>
	<title>The Private Car Service</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMs-9woEVpe_j9JfTjmwzET-av2cVhlTo"></script>
	<<link rel="stylesheet" href="style.css" />
  	<meta charset="utf-8">

	<script>
	
	var request = new XMLHttpRequest();
	var lat = -99999;
	var lng = -99999;

	var me = new google.maps.LatLng(lat, lng);

	var myOptions = {
		zoom: 13,
		center: me,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};

	var map;
	var marker;
	var infowindow = new google.maps.InfoWindow();

	function init() {

		request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);
		request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		getLocation();
	}

	function getLocation(){
		if (navigator.geolocation){
			navigator.geolocation.getCurrentPosition(function(position){
				lat = position.coords.latitude;
				lng = position.coords.longitude;

				renderMap();

				//send request with three parameters
				request.send("username=d4bazbp8&lat="+lat+"&lng="+lng);
			});
		} else {
			alert("Geolocation is not supported by your web browser. :(");
		}
	}

	function renderMap() {
		me = new google.maps.LatLng(lat, lng);
		// Update map and go there...
		map.panTo(me);
		
		// Create a marker
		marker = new google.maps.Marker({
			position: me,
			title: "You Are Here"
		});
		marker.setMap(map);
			
		// Open info window on click of marker
		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(this.title);
			infowindow.open(map, this);
		});
	}

	// function calculate_distance() {

	// 	var distance = google.maps.geometry.spherical.computeDistanceBetween(latLngA, latLngB);
	// }

	request.onreadystatechange = function() {

		if (request.readyState == 4 && request.status == 200){

			var vehicles = request.responseText;
			var list = JSON.parse(vehicles);

			for (count = 0 ; count < list.vehicles.length ; count++) {
				match = new google.maps.LatLng(list.vehicles[count].lat, list.vehicles[count].lng);

				marker = new google.maps.Marker({
					position: match,
					title: "vehicle"
				});

				marker.setMap(map);

				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(this.title);
					infowindow.open(map, this);
				});
			}
		}
	};
</script>
</head>

<body onload="init()">
	<div id="map_canvas"></div>

</body>
</html>